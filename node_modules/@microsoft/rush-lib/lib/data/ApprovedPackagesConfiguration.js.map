{"version":3,"sources":["data/ApprovedPackagesConfiguration.ts"],"names":[],"mappings":"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","file":"data/ApprovedPackagesConfiguration.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as fsx from 'fs-extra';\r\nimport * as path from 'path';\r\nimport * as os from 'os';\r\n\r\nimport JsonSchemaValidator from '../utilities/JsonSchemaValidator';\r\nimport JsonFile from '../utilities/JsonFile';\r\nimport Utilities from '../utilities/Utilities';\r\n\r\n/**\r\n * Part of IApprovedPackagesJson.\r\n */\r\nexport interface IApprovedPackagesItemJson {\r\n  name: string;\r\n  allowedCategories: string[];\r\n}\r\n\r\n/**\r\n * This represents the JSON data structure for the \"browser-approved-packages.json\"\r\n * and \"nonbrowser-approved-packages.json\" configuration files.  See \"approved-packages.schema.json\"\r\n * for documentation.\r\n */\r\nexport interface IApprovedPackagesJson {\r\n  $schema?: string;\r\n  packages: IApprovedPackagesItemJson[];\r\n}\r\n\r\n/**\r\n * An item returned by ApprovedPackagesConfiguration\r\n * @public\r\n */\r\nexport class ApprovedPackagesItem {\r\n  /**\r\n   * The NPM package name\r\n   */\r\n  public packageName: string;\r\n\r\n  /**\r\n   * The project categories that are allowed to use this package.\r\n   */\r\n  public allowedCategories: Set<string> = new Set<string>();\r\n}\r\n\r\n/**\r\n * This represents the JSON file specified via the \"approvedPackagesFile\" option in rush.json.\r\n * @public\r\n */\r\nexport class ApprovedPackagesConfiguration {\r\n  private static _validator: JsonSchemaValidator = undefined;\r\n\r\n  public items: ApprovedPackagesItem[] = [];\r\n\r\n  private _itemsByName: Map<string, ApprovedPackagesItem> = new Map<string, ApprovedPackagesItem>();\r\n\r\n  private _loadedJson: IApprovedPackagesJson;\r\n  private _jsonFilename: string;\r\n\r\n  public constructor(jsonFilename: string) {\r\n    this._jsonFilename = jsonFilename;\r\n    this.clear();\r\n  }\r\n\r\n  /**\r\n   * Clears all the settings, returning to an empty state.\r\n   */\r\n  public clear(): void {\r\n    this._itemsByName.clear();\r\n    this._loadedJson = {\r\n      packages: []\r\n    };\r\n  }\r\n\r\n  public getItemByName(packageName: string): ApprovedPackagesItem {\r\n    return this._itemsByName.get(packageName);\r\n  }\r\n\r\n  public addOrUpdatePackage(packageName: string, reviewCategory: string): void {\r\n    let item: ApprovedPackagesItem = this._itemsByName.get(packageName);\r\n    if (!item) {\r\n      item = new ApprovedPackagesItem();\r\n      item.packageName = packageName;\r\n      this._addItem(item);\r\n    }\r\n\r\n    if (reviewCategory) {\r\n      item.allowedCategories.add(reviewCategory);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * If the file exists, calls loadFromFile().\r\n   */\r\n  public tryLoadFromFile(approvedPackagesPolicyEnabled: boolean): boolean {\r\n    if (!fsx.existsSync(this._jsonFilename)) {\r\n      return false;\r\n    }\r\n\r\n    this.loadFromFile();\r\n\r\n    if (!approvedPackagesPolicyEnabled) {\r\n      console.log(`Warning: Ignoring \"${path.basename(this._jsonFilename)}\" because the`\r\n        + ` \"approvedPackagesPolicy\" setting was not specified in rush.json`);\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Loads the configuration data from the filename that was passed to the constructor.\r\n   */\r\n  public loadFromFile(): void {\r\n\r\n    if (!ApprovedPackagesConfiguration._validator) {\r\n      const schemaFilename: string = path.join(__dirname, '../approved-packages.schema.json');\r\n      ApprovedPackagesConfiguration._validator = JsonSchemaValidator.loadFromFile(schemaFilename);\r\n    }\r\n\r\n    const approvedPackagesJson: IApprovedPackagesJson = JsonFile.loadJsonFile(this._jsonFilename);\r\n\r\n    ApprovedPackagesConfiguration._validator.validateObject(approvedPackagesJson, (errorDescription: string) => {\r\n      throw new Error(`Error parsing file '${path.basename(this._jsonFilename)}':\\n`\r\n        + errorDescription);\r\n    });\r\n\r\n    this.clear();\r\n\r\n    for (const browserPackage of approvedPackagesJson.packages) {\r\n      this._addItemJson(browserPackage, this._jsonFilename);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loads the configuration data to the filename that was passed to the constructor.\r\n   */\r\n  public saveToFile(): void {\r\n    // Update the JSON structure that we already loaded, preserving any existing state\r\n    // (which passed schema validation).\r\n\r\n    this._loadedJson.packages = [];\r\n\r\n    this.items.sort((a: ApprovedPackagesItem, b: ApprovedPackagesItem) => {\r\n      return a.packageName.localeCompare(b.packageName);\r\n    });\r\n\r\n    for (const item of this.items) {\r\n      // Sort the items from the set.  Too bad we can't use the new Array.from().\r\n      const allowedCategories: string[] = Utilities.getSetAsArray(item.allowedCategories);\r\n      allowedCategories.sort();\r\n\r\n      const itemJson: IApprovedPackagesItemJson = {\r\n        name: item.packageName,\r\n        allowedCategories: allowedCategories\r\n      };\r\n\r\n      this._loadedJson.packages.push(itemJson);\r\n    }\r\n\r\n    // Save the file\r\n    let body: string = JSON.stringify(this._loadedJson, undefined, 2) + '\\n';\r\n\r\n    // Unindent the allowedCategories array to improve readability\r\n    body = body.replace(\r\n      /(\"allowedCategories\": +\\[)([^\\]]+)/g,\r\n      (substring: string, ...args: string[]) => {\r\n        return args[0] + args[1].replace(/\\s+/g, ' ');\r\n      }\r\n    );\r\n\r\n    // Add a header\r\n    body = '// DO NOT ADD COMMENTS IN THIS FILE.'\r\n      + '  They will be lost when the Rush tool resaves it.\\n' + body;\r\n\r\n    body = Utilities.getAllReplaced(body, '\\n', '\\r\\n');\r\n    fsx.writeFileSync(this._jsonFilename, body);\r\n  }\r\n\r\n  /**\r\n   * Helper function only used by the constructor when loading the file.\r\n   */\r\n  private _addItemJson(itemJson: IApprovedPackagesItemJson, jsonFilename: string): void {\r\n    if (this._itemsByName.has(itemJson.name)) {\r\n      throw new Error(`Error loading package review file ${jsonFilename}:` + os.EOL\r\n        + ` the name \"${itemJson.name}\" appears more than once`);\r\n    }\r\n\r\n    const item: ApprovedPackagesItem = new ApprovedPackagesItem();\r\n    item.packageName = itemJson.name;\r\n    if (itemJson.allowedCategories) {\r\n      for (const allowedCategory of itemJson.allowedCategories) {\r\n        item.allowedCategories.add(allowedCategory);\r\n      }\r\n    }\r\n    this._addItem(item);\r\n  }\r\n\r\n  /**\r\n   * Helper function that adds an already created ApprovedPackagesItem to the\r\n   * list and set.\r\n   */\r\n  private _addItem(item: ApprovedPackagesItem): void {\r\n    if (this._itemsByName.has(item.packageName)) {\r\n      throw new Error('Duplicate key'); // this is a program bug\r\n    }\r\n    this.items.push(item);\r\n    this._itemsByName.set(item.packageName, item);\r\n  }\r\n}\r\n"],"sourceRoot":"..\\..\\src"}