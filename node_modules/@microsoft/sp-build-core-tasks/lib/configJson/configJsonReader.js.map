{"version":3,"sources":["configJson/configJsonReader.ts"],"names":[],"mappings":"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","file":"configJson/configJsonReader.js","sourcesContent":["import * as fs from 'fs';\r\nimport * as path from 'path';\r\n\r\nimport { SchemaValidator } from '@microsoft/gulp-core-build/lib/jsonUtilities/SchemaValidator';\r\n\r\nimport { IConfigJson as IV1ConfigJson } from './interfaces/config-v1';\r\nimport {\r\n  IConfigJson as ILatestConfigJson,\r\n  configJsonSchemaUrl\r\n} from './interfaces/config-v2';\r\n\r\nconst V1_SCHEMA_FILE_PATH: string = path.join(__dirname, 'schemas', 'config.1.0.schema.json');\r\nconst V2_SCHEMA_FILE_PATH: string = path.join(__dirname, 'schemas', 'config.2.0.schema.json');\r\n\r\nexport const defaultConfigPath: string = path.join(process.cwd(), 'config', 'config.json');\r\n\r\ninterface IVersionedConfigJson {\r\n  version?: string;\r\n}\r\n\r\nexport interface IConfigJsonResult {\r\n  /**\r\n   * True if the file is missing.\r\n   */\r\n  missingFile: boolean;\r\n\r\n  /**\r\n   * Parse error data.\r\n   */\r\n  readError?: {};\r\n\r\n  /**\r\n   * The version of the original config file.\r\n   */\r\n  version?: string;\r\n\r\n  /**\r\n   * The data in the config file.\r\n   */\r\n  configData?: ILatestConfigJson;\r\n\r\n  /**\r\n   * True if the config file is the latest version.\r\n   */\r\n  isLatestVersion?: boolean;\r\n}\r\n\r\n/**\r\n * Read a V1 config file and translate it to the latest schema.\r\n */\r\nfunction _tryV1(filename: string, fileMetadata: IVersionedConfigJson): IConfigJsonResult | undefined {\r\n  const result: IConfigJsonResult = {\r\n    missingFile: false,\r\n    version: '1.0',\r\n    isLatestVersion: false\r\n  };\r\n\r\n  try {\r\n    const v1Config: IV1ConfigJson = SchemaValidator.readAndValidateJson<IV1ConfigJson>(filename, V1_SCHEMA_FILE_PATH);\r\n    const configData: ILatestConfigJson = {\r\n      '$schema': configJsonSchemaUrl,\r\n      version: '2.0',\r\n      bundles: {},\r\n      localizedResources: v1Config.localizedResources,\r\n      externals: v1Config.externals\r\n    };\r\n\r\n    if (v1Config.entries) {\r\n      for (const entry of v1Config.entries) {\r\n        const name: string = path.basename(entry.outputPath, path.extname(entry.outputPath));\r\n        configData.bundles[name] = {\r\n          components: [{\r\n            entrypoint: entry.entry,\r\n            manifest: entry.manifest\r\n          }]\r\n        };\r\n      }\r\n    }\r\n\r\n    if (configData.localizedResources) {\r\n      for (const resourceName in configData.localizedResources) {\r\n        const resourcePath: string = configData.localizedResources[resourceName];\r\n        configData.localizedResources[resourceName] = path.posix.join('lib', resourcePath);\r\n      }\r\n    }\r\n\r\n    result.configData = configData;\r\n  } catch (error) {\r\n    if (!fileMetadata.version) {\r\n      result.readError = error;\r\n    } else {\r\n      // Failed to validate, not the right version\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Read a V2 config file. This is currently the latest config version\r\n */\r\nfunction _tryV2(filename: string, fileMetadata: IVersionedConfigJson): IConfigJsonResult | undefined {\r\n  const result: IConfigJsonResult = {\r\n    missingFile: false,\r\n    version: '2.0',\r\n    isLatestVersion: true\r\n  };\r\n\r\n  try {\r\n    const configData: ILatestConfigJson =\r\n      SchemaValidator.readAndValidateJson<ILatestConfigJson>(filename, V2_SCHEMA_FILE_PATH);\r\n\r\n    result.configData = configData;\r\n  } catch (error) {\r\n    if (fileMetadata.version === result.version) {\r\n      result.readError = error;\r\n    } else {\r\n      // Failed to validate, not the right version\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nconst _parseFunctions: ((filename: string, fileMetadata: IVersionedConfigJson) => IConfigJsonResult | undefined)[] = [\r\n  _tryV2,\r\n  _tryV1\r\n];\r\n\r\nexport function readConfigFile( // tslint:disable-line:export-name\r\n  logVerbose: (message: string) => void,\r\n  filename: string = defaultConfigPath\r\n): IConfigJsonResult {\r\n  if (!fs.existsSync(filename)) {\r\n    return {\r\n      missingFile: true\r\n    };\r\n  } else {\r\n    logVerbose(`Found config file: ${path.basename(filename)}`);\r\n\r\n    let fileMetadata: IVersionedConfigJson;\r\n    try {\r\n      // Read the file to detect basic metadata\r\n      fileMetadata = SchemaValidator.readCommentedJsonFile(filename);\r\n    } catch (error) {\r\n      return {\r\n        missingFile: false,\r\n        readError: error\r\n      };\r\n    }\r\n\r\n    let result: IConfigJsonResult | undefined = undefined;\r\n    for (let i: number = 0; i < _parseFunctions.length && !result; i++) {\r\n      result = _parseFunctions[i](filename, fileMetadata);\r\n    }\r\n\r\n    return result || {\r\n      missingFile: false,\r\n      version: fileMetadata.version,\r\n      isLatestVersion: false,\r\n      readError: 'Unknown config.json file format.'\r\n    };\r\n  }\r\n}\r\n"],"sourceRoot":"..\\..\\src"}