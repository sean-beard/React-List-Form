{"version":3,"sources":["BuildRig.ts"],"names":[],"mappings":"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","file":"BuildRig.js","sourcesContent":["import * as Gulp from 'gulp';\r\nimport * as yargs from 'yargs';\r\n\r\nimport * as coreBuild from '@microsoft/gulp-core-build';\r\n\r\nimport { BuildRigConstants } from './BuildRigConstants';\r\n\r\n/**\r\n * The flags which this build rig defines. Extend this for child rigs\r\n */\r\nexport interface ICoreBuildArgs {\r\n  // Note the production and ship flags should have the same value\r\n  production: boolean;\r\n  ship: boolean;\r\n  // A special flag for then they run --tasks\r\n  tasks: boolean;\r\n  verbose: boolean;\r\n}\r\n\r\n/**\r\n * Represents the a task which is registered to the gulp command line\r\n * The arguments function is evaluated if this is the current task, it should\r\n * interact with yargs to define any custom values.\r\n *\r\n * @todo 178074 this code should be removed\r\n */\r\nexport interface ITaskDefinition {\r\n  executable: coreBuild.IExecutable;\r\n  arguments?: (args: yargs.Argv) => void;\r\n}\r\n\r\n/**\r\n * Represents a gulp-core-build build \"rig\", or a collection of tasks and\r\n * configurations. It can be extended to define more top-level configurable tasks,\r\n * inject subtasks into the chain, register arguments to the command line.\r\n *\r\n * This class represents all the logic which doesn't belong in a rig, and should instead\r\n * be a part of gulp-core-build. Thus, this class should be removed once that logic\r\n * is properly replicated in gulp-core-build.\r\n *\r\n * @todo 178074, 253519, 253526\r\n */\r\nexport abstract class BuildRig {\r\n  protected args: ICoreBuildArgs;\r\n\r\n  /**\r\n   * The primary entry point into this build rig, accepts a gulp instance which is passed through to gulp-core-build\r\n   */\r\n  public initialize(gulp: typeof Gulp): void {\r\n\r\n    // Initialize yargs & figure out which command we are running\r\n    const yargsArgs: yargs.Argv = this.getYargs();\r\n    const command: string = yargsArgs.argv._[0];\r\n    this.args = yargsArgs.argv;\r\n\r\n    // Collect the tasks which need to be registered\r\n    const tasks: Map<string, ITaskDefinition> = this.getTasks();\r\n\r\n    // Reset the args and reconfigure based on the selected command\r\n    yargsArgs.reset();\r\n    if (tasks.has(command)) {\r\n      const task: ITaskDefinition = tasks.get(command);\r\n      if (task.arguments) {\r\n        task.arguments(yargsArgs);\r\n      }\r\n    }\r\n\r\n    // Note this overrides the getters for ship and production on args\r\n    this.args.ship = this.args.production = (this.args.production || this.args.ship);\r\n\r\n    // Since gulp-core-build doesn't recognize the --ship flag, ensure it gets the right state\r\n    coreBuild.mergeConfig({\r\n      production: this.args.ship,\r\n      shouldWarningsFailBuild: this.args.ship\r\n    });\r\n\r\n    const configureRigTask: coreBuild.IExecutable | undefined = this.getConfigureRigTask();\r\n\r\n    // Register all the tasks with gulp-core-build\r\n    tasks.forEach((definition: ITaskDefinition, name: string): void => {\r\n      if (configureRigTask) {\r\n        coreBuild.task(name, coreBuild.serial(configureRigTask, definition.executable));\r\n      } else {\r\n        coreBuild.task(name, definition.executable);\r\n      }\r\n    });\r\n\r\n    // If they are just looking for the task list, save time by not reading config files\r\n    if (!this.args.tasks) {\r\n      // Configure tasks for a normal build\r\n      console.log('Build target: ' + (this.args.ship ?\r\n        BuildRigConstants.flavors.ship.toUpperCase() :\r\n        BuildRigConstants.flavors.debug.toUpperCase()));\r\n\r\n      this.setupSharedConfig();\r\n    }\r\n\r\n    coreBuild.initialize(gulp);\r\n\r\n    // If they are just looking for the task list, save time by not reading config files\r\n    if (!this.args.tasks) {\r\n      this.finalizeSharedConfig();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Optionally override this function to provide a task that always runs before all other tasks to\r\n   *  configure the build rig for the build run. For example, one may provide a task that sets initial\r\n   *  values in the buildConfig.properties object from a config.json file.\r\n   */\r\n  protected getConfigureRigTask(): coreBuild.IExecutable | undefined {\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * Override this function to create new top-level tasks which can be executed via the command line\r\n   */\r\n  protected abstract getTasks(): Map<string, ITaskDefinition>;\r\n\r\n  /**\r\n   * Override this function to do configuration before the configuration .json files have been loaded\r\n   */\r\n  protected abstract setupSharedConfig(): void;\r\n\r\n  /**\r\n   * Override this function to do configuration after the configuration .json files have been loaded\r\n   */\r\n  protected abstract finalizeSharedConfig(): void;\r\n\r\n  /**\r\n   * Override this function to register more top-level command line arguments (i.e. not task-specific).\r\n   * Ideally, extend the ICoreBuildArgs when hooking into this function\r\n   * @todo 253519 : this code should be removed once we determine the interface for argument parsing with GCB\r\n   */\r\n  protected getYargs(): yargs.Argv {\r\n    const yargsArgs: yargs.Argv = yargs.usage()\r\n      .option('production', {\r\n        alias: 'p',\r\n        describe: 'build in ship mode with full localization and minimization',\r\n        boolean: true\r\n      })\r\n      .option('ship', {\r\n        alias: 'p',\r\n        describe: 'build in ship mode with full localization and minimization',\r\n        boolean: true\r\n      })\r\n      .option('verbose', {\r\n        describe: 'run the build with verbose logging'\r\n      })\r\n      .option('tasks', {\r\n        alias: ['T', 'tasks-simple'],\r\n        describe: 'shows the list of tasks which can be run'\r\n      })\r\n      .help('h')\r\n      .global(['production', 'verbose', 'h']);\r\n    return yargsArgs;\r\n  }\r\n\r\n  protected _disableTasks(...tasks: coreBuild.IExecutable[]): void {\r\n    tasks.forEach((task: coreBuild.IExecutable) => {\r\n      task.isEnabled = () => false;\r\n      coreBuild.verbose(`Disabling task: ${task.name}`);\r\n    });\r\n  }\r\n}"],"sourceRoot":"..\\src"}